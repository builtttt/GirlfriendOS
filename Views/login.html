<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Status Panel</title>
  <meta name="theme-color" content="#fbcfe8" />
  <style>
    :root{
      --bg1:#fdf2f8;
      --bg2:#e0f2fe;
      --card:#ffffffcc;
      --muted:#6b7280;
      --text:#3f3f46;
      --accent:#a5b4fc;
      --accent2:#f9a8d4;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
      --soft:#fce7f3;
	  --pill-size: 38px;     /* was 48px */
	  --mini-size: 28px;     /* was 36px */
	  --emoji-size: 14px;   /* was 18px */
	  --pill-padding: 4px;  /* was 6px */
	  --gap: 8px;           /* was 10px */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Segoe UI Emoji";
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--text);
      padding:16px;
      min-height:100vh;
    }
	
	body.theme-switching{
	  opacity:.985;
	}
	
	/* BF Theme (dark-ish, clean) */
	body.theme-bf{
	  background: linear-gradient(135deg,#0b1220,#111827);
	  color:#e5e7eb;
	  --bg1:#0b1220;
	  --bg2:#111827;
	  --text:#e5e7eb;
	}
	
	body.theme-bf .chip{ background:#0f172a; color:#cbd5e1; }
	body.theme-bf .card{ background: rgba(15,23,42,.72); }
	body.theme-bf .val{ background:#0b1220; color:#e5e7eb; }
	body.theme-bf .slider{ background:#1f2937; }
	body.theme-bf .pill{ background:#0f172a; }
	body.theme-bf .bf{ background: rgba(249,168,212,.12); color:#e5e7eb; }

	body.theme-bf .aff-square{ background:#0f172a; }
	body.theme-bf .aff-square .txt{ color:#cbd5e1; }
	body.theme-bf .slot { background:#0f172a; }
	body.theme-bf .slot .txt{ color:#cbd5e1; }
	body.theme-bf .keypad button { background:#0f172a; }
	body.theme-bf .keypad button .txt{ color:#cbd5e1; }
	body.theme-bf .btn-ghost { background:rgba(249,168,212,.12);color:#e5e7eb; }

	body.theme-bf .sendbar{
	  background: linear-gradient(to top,#0b1220,transparent);
	}
	body,
	.card,
	.chip,
	.pill,
	.val,
	.bf,
	.aff-square,
	.sendbar {
	  transition:
		background-color 260ms ease,
		color 260ms ease,
		box-shadow 260ms ease,
		border-color 260ms ease;
	}
    .wrap{max-width:560px;margin:0 auto;padding-bottom:28px;}
    header{display:flex;justify-content:space-between;align-items:flex-start;margin:6px 0 14px;}
    h1{margin:0;font-size:22px}
    .subhead{font-size:13px;color:var(--muted);margin-top:4px}
    .card{
      background:var(--card);
      backdrop-filter: blur(6px);
      border-radius:var(--radius);
      padding:14px;
      margin:12px 0;
      box-shadow:var(--shadow);
    }
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .label{font-weight:700;font-size:14px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .btn{
      width:100%;
      padding:14px;
      border:0;
      border-radius:14px;
      font-weight:800;
      font-size:15px;
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      color:white;
      box-shadow:0 8px 20px rgba(0,0,0,.12);
      cursor:pointer;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn-ghost{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      font-weight:700;
      cursor:pointer;
    }
    .tiny{
      font-size:12px;color:var(--muted)
    }
    .input{
      width:100%;
      padding:13px 14px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      outline:none;
      font-size:14px;
      background:#fff;
    }
    .hintBox{
      background:#fff;
      border:1px dashed rgba(0,0,0,.15);
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      color:var(--muted);
    }

    /* screens */
    .screen{display:none}
    .screen.active{display:block}

    /* Emoji code input */
    .codeRow{
      display:flex;
      gap:10px;
      margin-top:12px;
      justify-content:space-between;
    }
    .slot{
      flex:1;
      aspect-ratio: 1/1;
      border-radius:16px;
      background:#fff;
      border:2px solid rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:34px;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
      user-select:none;
    }
    .slot.filled{
      border-color: rgba(249,168,212,.75);
      background: #fff7fb;
    }
    .slot.active{
      outline: 3px solid rgba(165,180,252,.55);
      outline-offset: 2px;
    }
    .codeActions{
      display:flex;
      gap:10px;
      margin-top:12px;
    }

    /* Emoji picker (scrollable) */
    .pickerWrap{
      margin-top:14px;
    }
    .pickerHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .picker{
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap:8px;
      max-height: 220px;
      overflow:auto;
      padding-right:4px;
    }
    .eBtn{
      border:0;
      background:#fff;
      border-radius:14px;
      aspect-ratio: 1/1;
      font-size:22px;
      cursor:pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.06);
      transition: transform .12s ease;
    }
    .eBtn:active{transform: scale(.95)}
    .picker::-webkit-scrollbar{width:10px}
    .picker::-webkit-scrollbar-thumb{background: rgba(0,0,0,.12);border-radius:999px}

    /* Result code */
    .codeBig{
      display:flex;
      gap:10px;
      justify-content:center;
      margin-top:12px;
    }
    .bigChip{
      width:66px;
      aspect-ratio:1/1;
      border-radius:18px;
      background: var(--soft);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:36px;
      border:1px solid rgba(0,0,0,.06);
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background:#111827;
      color:#fff;
      font-size:13px;
      padding:10px 12px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transition: opacity 0.25s ease;
    }
    .toast.show{opacity:1}

    @media (max-width:420px){
      .picker{grid-template-columns: repeat(6, 1fr);}
    }
	.keypad{
	  display:grid;
	  grid-template-columns: repeat(3, 1fr);
	  gap:10px;
	  margin-top:14px;
	  max-width:260px;       /* keeps the pad compact */
	  margin-left:auto;
	  margin-right:auto;
	}

	.keypad button{
	  border:0;
	  background:#fff;
	  border-radius:16px;
	  aspect-ratio: 1 / 1;
	  font-size:28px;        /* smaller emoji */
	  cursor:pointer;
	  box-shadow: 0 6px 14px rgba(0,0,0,.08);
	  border:1px solid rgba(0,0,0,.06);
	  transition: transform .12s ease;
	}

	.keypad button:active{
	  transform: scale(.92);
	}

    /* the morphing pill */
    .morph-pill {
      height: var(--pill-size);
      width:  var(--pill-size);                 /* collapsed circle */
      border-radius: 999px;
      background: #fff;
	  

      display: inline-flex;
      align-items: center;

      /* IMPORTANT: anchor on the right so it expands left */
      justify-content: flex-end;

      overflow: hidden;
      white-space: nowrap;

      padding: 0;                   /* becomes padding when open */
      cursor: pointer;
      user-select: none;

      transition:
        width 420ms cubic-bezier(.2,.9,.2,1),
        padding 420ms cubic-bezier(.2,.9,.2,1),
        box-shadow 220ms ease,
        transform 120ms ease;
    }

    .morph-pill:active { transform: scale(0.98); }

    /* inner row that measures content */
    .morph-row {
      display: inline-flex;
      align-items: center;
      gap: var(--gap);
      padding-right: 4px;           /* keeps the right edge comfy */
    }

    /* the 3 circle buttons */
    .mini-btn {
      width: var(--mini-size);
      height: var(--mini-size);
      border-radius: 999px;
      background: #fff;
	  padding: 0px;

      display: inline-grid;
      place-items: center;

      font-size: var(--emoji-size);
      cursor: pointer;

      transition: transform 120ms ease, box-shadow 180ms ease;
      flex:1;
      border:0;
      font-weight:700;
      color:white;
      box-shadow:0 8px 20px rgba(0,0,0,.12);
    }

    .mini-btn:hover { box-shadow: 0 6px 16px rgba(0,0,0,.12); transform: translateY(-1px); }
    .mini-btn:active { transform: translateY(0) scale(0.98); }

    /* collapsed state: only show the right-most button */
    .morph-pill:not(.open) .mini-btn:not(:last-child) {
      opacity: 0;
      transform: translateX(10px);
      pointer-events: none;
    }

    .morph-pill .mini-btn {
      transition: opacity 220ms ease, transform 420ms cubic-bezier(.2,.9,.2,1), box-shadow 180ms ease;
    }

    /* open visuals */
    .morph-pill.open {
      box-shadow: 0 8px 22px rgba(0,0,0,.12);
      padding: var(--pill-padding);                 /* creates pill breathing room */
    }

    .pill{
      background:#f9fafb;
      padding:10px;
      border-radius:14px;
    }
    .pill .k{font-size:12px;color:var(--muted)}
    .pill .v{font-weight:700}
    .bf{
      margin-top:10px;
      padding:10px;
      background:#fff0f6;
      border-radius:14px;
      font-size:13px;
    }

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Status Panel</h1>
        <div class="subhead">Code eingeben und Status senden üíå</div>
      </div>
	  
		<div class="morph-pill" id="pill" role="group" aria-label="Quick actions">
		  <div class="morph-row" id="row">
			<button class="mini-btn" type="button" aria-label="Forgot" id="btnForgot">‚ùì</a>
			<button class="mini-btn" type="button" aria-label="Theme" id="themeToggle">‚òÄÔ∏è</button>
			<button class="mini-btn" type="button" aria-label="Settings">‚öôÔ∏è</button>
		  </div>
		</div>
    </header>

    <!-- SCREEN: LOGIN -->
    <div class="screen active" id="screenLogin">
      <div class="card">
        <div class="row">
          <div>
            <div class="label">Anmelden</div>
            <div class="sub">Gib deinen Pair Code ein (4 Emojis)</div>
          </div>
        </div>

        <div class="codeRow" id="codeRow">
          <div class="slot active" data-i="0" id="slot0">‚¨ú</div>
          <div class="slot" data-i="1" id="slot1">‚¨ú</div>
          <div class="slot" data-i="2" id="slot2">‚¨ú</div>
          <div class="slot" data-i="3" id="slot3">‚¨ú</div>
        </div>

        <div class="codeActions">
          <button class="btn-ghost" type="button" id="backspaceBtn">‚å´ L√∂schen</button>
          <button class="btn-ghost" type="button" id="clearBtn">Alles l√∂schen</button>
        </div>

        <div class="pickerWrap">
          <div class="keypad" id="emojiKeypad"></div>
        </div>

        <div style="margin-top:14px;">
          <button class="btn" type="button" id="loginBtn" disabled>Einloggen</button>
          <div class="tiny" style="margin-top:8px;" id="loginHint">
            Tipp: Du kannst den Code auch als Screenshot speichern.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <div class="label">Noch kein Pair?</div>
            <div class="sub">Erstelle einen neuen Pair Code und trage die E-Mail deines BF ein.</div>
          </div>
        </div>
        <button class="btn-ghost" type="button" id="goCreateBtn" style="margin-top:10px;">Neues Pair erstellen</button>
      </div>
    </div>

    <!-- SCREEN: CREATE -->
    <div class="screen" id="screenCreate">
      <div class="card">
        <div class="row">
          <div>
            <div class="label">Neues Pair erstellen</div>
            <div class="sub">Dein BF bekommt Status Updates per E-Mail.</div>
          </div>
        </div>

		<div style="margin-top:12px;">
		  <div class="tiny" style="margin-bottom:6px;">Dein Name</div>
		  <input class="input" id="gfName" type="text" placeholder="z.B. Lisa" autocomplete="name" />
		</div>

		<div style="margin-top:12px;">
		  <div class="tiny" style="margin-bottom:6px;">E-Mail vom BF</div>
		  <input class="input" id="bfEmail" type="email" placeholder="z.B. max@example.com" autocomplete="email" />
		</div>

        <div style="margin-top:12px;">
			<button class="btn" type="button" id="createBtn">Pair erstellen</button>
          <div class="tiny" style="margin-top:8px;">
            Du erh√§ltst danach deinen pers√∂nlichen Emoji Pair Code.
          </div>
        </div>
      </div>

      <div class="card" id="resultCard" style="display:none;">
        <div class="row">
          <div>
            <div class="label">Dein Pair Code</div>
            <div class="sub">Bitte merken oder Screenshot machen.</div>
          </div>
        </div>

        <div class="codeBig" id="createdCodeBig"></div>

        <div class="hintBox" style="margin-top:12px;" id="createdCodeText"></div>

        <div class="codeActions" style="margin-top:12px;">
          <button class="btn-ghost" type="button" id="copyCodeBtn">üìã Kopieren</button>
          <button class="btn-ghost" type="button" id="useForLoginBtn">‚úÖ Zum Login √ºbernehmen</button>
        </div>
      </div>

      <button class="btn-ghost" type="button" id="backToLoginBtn">‚Üê Zur√ºck zum Login</button>
    </div>
  </div>

  <div class="toast" id="toast">Kopiert ‚úÖ</div>


  <script>
	  // ---- Emoji pool (must match backend IDs 0..N-1) ----
	  // IMPORTANT: order matters. Backend uses emoji IDs. Same order here.
	    const EMOJIS = [
			"üêª","üêº","üê∞","üê∂","üê±","üêπ","ü¶ä","üê∏",
			"üê•","ü¶Ñ","üêô","üê≥","üêù","ü¶ã","üêû","ü¶ï",
			"üçì","üçí","üçë","üçâ","üçá","üç™","üç∞","üßÅ",
			"üç©","üç¶","üç´","üçø","üçú","üçî","üçü","üçï",
			"üå∏","üåº","üå∑","üåª","üçÄ","üåà","‚≠ê","‚ú®",
			"üåô","‚òÅÔ∏è","üî•","üí´","üéÄ","üß∏","ü´∂","üíñ",
			"üëΩ","üëô","üíÑ","üíç","üíã","üòà","üòá","ü•π",
			"ü™Ñ","üéß","üì∏","üéÆ","üßã","ü´ß","üïØÔ∏è","ü™ª" 
		];

	  // ---- UI helpers ----
	  const el = (id) => document.getElementById(id);
	  const show = (id) => {
		document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
		el(id).classList.add("active");
	  };
	  const toast = (msg) => {
		const t = el("toast");
		t.textContent = msg;
		t.classList.add("show");
		setTimeout(() => t.classList.remove("show"), 5000);
	  };

	  // ---- Option B login state ----
	  let boards = null;        // 4 x 9 (emojiIds)
	  let challengeToken = "";  // signed token from /api/login/start
	  let step = 0;             // 0..3
	  let answers = [];         // chosen indices 0..8 per step

	  // Slots show chosen emojis
	  let code = ["", "", "", ""];
	  let activeIndex = 0;

	  function renderSlots(){
		for(let i=0;i<4;i++){
		  const slot = el("slot"+i);
		  slot.textContent = code[i] ? code[i] : "‚¨ú";
		  slot.classList.toggle("filled", !!code[i]);
		  slot.classList.toggle("active", i === activeIndex);
		}
	  }

	  function clearAll(){
		code = ["","","",""];
		activeIndex = 0;
		step = 0;
		answers = [];
		renderSlots();
		renderKeypad();
	  }

	  function backspace(){
		// allow user to undo last choice
		if(answers.length === 0) return;

		answers.pop();
		step = answers.length;

		code[step] = "";
		activeIndex = step;

		renderSlots();
		renderKeypad();
	  }

	  // Click slot to set active index (not super needed now, but keep it)
	  document.querySelectorAll(".slot").forEach(s => {
		s.addEventListener("click", () => {
		  activeIndex = Number(s.dataset.i);
		  renderSlots();
		});
	  });

	  el("backspaceBtn").addEventListener("click", backspace);
	  el("clearBtn").addEventListener("click", clearAll);

	  // ---- Keypad now renders the current 3x3 board ----
	  const keypad = el("emojiKeypad");

	  function emojiFromId(id){
		// fallback for mismatch
		return EMOJIS[id] ?? "‚ùì";
	  }

	  function renderKeypad(){
		keypad.innerHTML = "";

		if(!boards){
		  // before start: show placeholders
		  for(let i=0;i<9;i++){
			const b = document.createElement("button");
			b.type = "button";
			b.textContent = "‚¨ú";
			b.disabled = true;
			keypad.appendChild(b);
		  }
		  return;
		}

		const board = boards[step];
		for(let i=0;i<9;i++){
		  const emojiId = board[i];
		  const b = document.createElement("button");
		  b.type = "button";
		  b.textContent = emojiFromId(emojiId);
		  b.addEventListener("click", () => pickCell(i, emojiId));
		  keypad.appendChild(b);
		}

		el("loginHint").textContent = `Step ${step+1}/4: Tippe ein Emoji`;
	  }

	  function pickCell(cellIndex, emojiId){
		if(!boards) return;
		if(step > 3) return;

		// store answer and show chosen emoji in slots
		answers[step] = cellIndex;
		code[step] = emojiFromId(emojiId);
		activeIndex = Math.min(step + 1, 3);

		step++;

		renderSlots();

		if(step >= 4){
		  finishLogin().catch(err => {
			console.error(err);
		  });
		  return;
		}

		renderKeypad();
	  }

	  // ---- API calls ----
	  async function startLogin(){
		el("loginBtn").disabled = true;
		el("loginHint").textContent = "Starte Login‚Ä¶";

		// reset state
		boards = null;
		challengeToken = "";
		clearAll();

		try{
		  const pairId = localStorage.getItem("pairId");
			if(!pairId){
			  toast("Kein PairId. Bitte zuerst Pair erstellen.");
			  el("loginBtn").disabled = false;
			  return;
			}

			const res = await fetch(`/api/login/start?pairId=${encodeURIComponent(pairId)}`, {
			  method: "POST",
			  headers: { "Content-Type": "application/json" },
			  body: "{}"
			});


		  if(!res.ok){
			const t = await res.text().catch(() => "");
			throw new Error(`HTTP ${res.status} ${t}`.trim());
		  }

		  const data = await res.json();
		  // expected: { boards: int[][], token: string }
            boards = data.boards ?? data.Boards;
            challengeToken = data.token ?? data.Token;


		  if(!boards || boards.length !== 4) throw new Error("Bad boards");
		  if(!challengeToken) throw new Error("Missing token");

		  toast("Bereit ‚úÖ");
		  el("loginBtn").disabled = true; // now user taps keypad instead
		  renderSlots();
		  renderKeypad();
		}catch(err){
		  console.error(err);
		  toast("Login Start Fehler");
		  el("loginBtn").disabled = false;
		  el("loginHint").textContent = "Fehler beim Start. /api/login/start erreichbar?";
		}
	  }

	  async function finishLogin(){
		el("loginHint").textContent = "Pr√ºfe‚Ä¶";

		try{
		  const res = await fetch("/api/login/finish", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({
			  token: challengeToken,
			  answers: answers
			})
		  });

		  if(!res.ok){
			// wrong code or expired
			if(res.status === 401){
			  toast("Falsch ‚ùå");
			  await restartChallenge();
			  return;
			}
			const t = await res.text().catch(() => "");
			throw new Error(`HTTP ${res.status} ${t}`.trim());
		  }

		  const data = await res.json();
			const sessionToken = data?.sessionToken ?? data?.SessionToken;
            if (!sessionToken) throw new Error("Missing sessionToken");
            localStorage.setItem("gf_session", sessionToken);
			;
		  toast("Login ‚úÖ");
		  window.location.href = "index.html";
		}catch(err){
		  console.error(err);
		  toast("Login Fehler");
		  el("loginHint").textContent = "Fehler beim Login.";
		  // allow retry
		  await restartChallenge();
		}
	  }

	  async function restartChallenge(){
		// start fresh challenge (new token + new boards)
		boards = null;
		challengeToken = "";
		clearAll();
		el("loginBtn").disabled = false;
		el("loginHint").textContent = "Tippe auf Einloggen zum Neustart.";
		renderKeypad();
	  }

	  // Login button now starts the challenge (not submit a typed code)
	  el("loginBtn").addEventListener("click", async () => {
		await startLogin();
	  });
		function emojiStrFromIds(ids){
		  return ids.map(id => emojiFromId(id)).join("");
		}

		function renderCreatedFromIds(ids){
		  const codeStr = emojiStrFromIds(ids);

		  el("createdCodeBig").innerHTML = "";
		  for(const ch of [...codeStr]){
			const chip = document.createElement("div");
			chip.className = "bigChip";
			chip.textContent = ch;
			el("createdCodeBig").appendChild(chip);
		  }
		  el("createdCodeText").textContent = "Dein Pair Code ist: " + codeStr;
		}
		el("createBtn").addEventListener("click", async () => {
		  const gfName = (el("gfName")?.value || "").trim();
		  const bfEmail = (el("bfEmail")?.value || "").trim();

		  if(!gfName){
			toast("Bitte deinen Namen eingeben");
			return;
		  }
		  if(!bfEmail || !bfEmail.includes("@")){
			toast("Bitte g√ºltige E-Mail");
			return;
		  }

		  try{
			const res = await fetch("/api/register", {
			  method: "POST",
			  headers: { "Content-Type": "application/json" },
			  body: JSON.stringify({ gfName, bfEmail })
			});

			if(!res.ok){
			  const t = await res.text().catch(() => "");
			  throw new Error(`HTTP ${res.status} ${t}`.trim());
			}

			const data = await res.json();
			const pairId = data?.pairId ?? data?.PairId;
			const emojiIds = data?.emojiIds ?? data?.EmojiIds;

			if(!pairId || !emojiIds || emojiIds.length !== 4){
			  throw new Error("Bad register response");
			}

			// store for later
			localStorage.setItem("pairId", pairId);
			localStorage.setItem("lastCreatedEmojiIds", JSON.stringify(emojiIds));
			localStorage.setItem("lastCreatedPairCode", emojiStrFromIds(emojiIds));

			// show result
			renderCreatedFromIds(emojiIds);

			el("resultCard").style.display = "block";
			toast("Pair erstellt ‚úÖ");

			// optional: automatically go to login screen now
			// show("screenLogin");
		  }catch(err){
			console.error(err);
			toast("Register Fehler ‚ùå");
			alert("Pair erstellen fehlgeschlagen. Check /api/register.");
		  }
		});

		el("useForLoginBtn").addEventListener("click", async () => {
		  show("screenLogin");
		  toast("Jetzt einloggen ‚úÖ");
		  // start challenge immediately:
		  await startLogin();
		});
		el("copyCodeBtn").addEventListener("click", async () => {
		  const codeStr = localStorage.getItem("lastCreatedPairCode") || "";
		  if(!codeStr){
			toast("Kein Code");
			return;
		  }

		  try{
			await navigator.clipboard.writeText(codeStr);
			toast("Kopiert ‚úÖ");
		  }catch{
			// fallback for browsers where clipboard API is blocked
			const ta = document.createElement("textarea");
			ta.value = codeStr;
			ta.style.position = "fixed";
			ta.style.left = "-9999px";
			document.body.appendChild(ta);
			ta.focus();
			ta.select();
			try{
			  document.execCommand("copy");
			  toast("Kopiert ‚úÖ");
			}catch{
			  toast("Kopieren nicht m√∂glich");
			  alert("Copy failed. Code: " + codeStr);
			}finally{
			  ta.remove();
			}
		  }
		});

	  // Navigation
	  el("goCreateBtn").addEventListener("click", () => show("screenCreate"));
	  el("backToLoginBtn").addEventListener("click", () => show("screenLogin"));

	  // Init
	  // Disable keypad until startLogin()
	  renderSlots();
	  renderKeypad();
	  el("loginHint").textContent = "Tippe auf Einloggen. Dann w√§hle 4 Emojis.";
	  el("loginBtn").disabled = false;

		const pill = document.getElementById("pill");
		const row = document.getElementById("row");

		function setCollapsed() {
		  pill.classList.remove("open");
		  pill.style.width = "38px";
		  pill.style.padding = "0px";
		}

		function setOpen() {
		  pill.classList.add("open");
		  // Measure content width and set pill width so it expands LEFT and fits contents.
		  // The right edge stays fixed because the container is fixed to top-right.
			const targetWidth = 110;
		  pill.style.width = targetWidth + "px";
		}

		// Start collapsed
		setCollapsed();

		// Toggle on click (clicking anywhere on the pill)
		pill.addEventListener("click", (e) => {
		  // If you only want the right-most button to toggle, remove this and attach to that button.
		  const isOpen = pill.classList.contains("open");
		  if (isOpen) setCollapsed();
		  else setOpen();
		});

		// Close when clicking outside
		document.addEventListener("click", (e) => {
		  if (!pill.contains(e.target)) setCollapsed();
		});

		// Recalculate when window resizes (fonts, zoom, etc.)
		window.addEventListener("resize", () => {
		  if (pill.classList.contains("open")) setOpen();
		});
		
	const themeToggle = document.getElementById("themeToggle");

	function applyTheme(theme){
	  document.body.classList.add("theme-switching");
	  document.body.classList.toggle("theme-bf", theme === "bf");
	  themeToggle.textContent = theme === "bf" ? "‚òÄÔ∏è" : "üåô";
	  localStorage.setItem("girlfriendos_theme", theme);
	  setTimeout(() => {
      document.body.classList.remove("theme-switching");
	  }, 300);
	}

	themeToggle.addEventListener("click", () => {
	  const current = localStorage.getItem("girlfriendos_theme") || "gf";
	  applyTheme(current === "gf" ? "bf" : "gf");
	});
	const btnForgot = document.getElementById('btnForgot');

	btnForgot.addEventListener('click', () => {
	  toast('Pair-Code vergessen? Einfach ein neues Pair erstellen üòÑ');
	});


	// init theme
	applyTheme(localStorage.getItem("girlfriendos_theme") || "gf");

</script>

</body>
</html>
