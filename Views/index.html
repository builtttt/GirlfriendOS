<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Freundin Status Panel</title>
  <meta name="theme-color" content="#fbcfe8" />
  <style>
    :root{
      --bg:#fdf2f8;
      --card:#ffffffcc;
      --muted:#6b7280;
      --text:#3f3f46;
      --accent:#a5b4fc;
      --accent2:#f9a8d4;
      --ok:#86efac;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
	  --bg1:#fdf2f8;
	  --bg2:#e0f2fe;
	  --text:#3f3f46;
	  --pill-size: 38px;     /* was 48px */
	  --mini-size: 28px;     /* was 36px */
	  --emoji-size: 14px;   /* was 18px */
	  --pill-padding: 4px;  /* was 6px */
	  --gap: 8px;           /* was 10px */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(135deg,#fdf2f8,#e0f2fe);
      color:var(--text);
      padding:16px;
	  transition: background 300ms ease, color 260ms ease;
    }
	body.theme-switching{
	  opacity:.985;
	}
    .wrap{
      max-width:560px;
      margin:0 auto;
      padding-bottom:120px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:14px;
    }
    h1{
      margin:0;
      font-size:22px;
    }
    .subhead{
      font-size:13px;
      color:var(--muted);
      margin-top:4px;
    }
    .chip{
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      box-shadow:var(--shadow);
      color:var(--muted);
    }
    .card{
      background:var(--card);
      backdrop-filter: blur(6px);
      border-radius:var(--radius);
      padding:14px;
      margin:12px 0;
      box-shadow:var(--shadow);
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .label{font-weight:600;font-size:14px}
    .sub{font-size:12px;color:var(--muted)}
    .val{
      background:#f3f4f6;
      padding:6px 10px;
      border-radius:999px;
      font-size:13px;
      min-width:56px;
      text-align:center;
    }
    .slider{
      width:100%;
      margin:10px 0 4px;
      appearance:none;
      height:10px;
      border-radius:999px;
      background:#e5e7eb;
    }
    .slider::-webkit-slider-thumb{
      appearance:none;
      width:22px;
      height:22px;
      border-radius:50%;
      background:var(--accent2);
      cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,.15);
    }
    .hint{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      color:var(--muted);
    }
    .summary{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .pill{
      background:#f9fafb;
      padding:10px;
      border-radius:14px;
    }
    .pill .k{font-size:12px;color:var(--muted)}
    .pill .v{font-weight:700}
    .bf{
      margin-top:10px;
      padding:10px;
      background:#fff0f6;
      border-radius:14px;
      font-size:13px;
    }
    .sendbar{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      padding:12px 16px;
      background:linear-gradient(to top,#fdf2f8,transparent);
    }
    .sendwrap{
      max-width:560px;
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:center;
    }
    button{
      flex:1;
      padding:14px;
      border:0;
      border-radius:14px;
      font-weight:700;
      font-size:15px;
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      color:white;
      box-shadow:0 8px 20px rgba(0,0,0,.12);
    }
	
	/* Theme button */
	.themeBtn{
	  flex:0 0 auto;
	  padding:10px 12px;
	  border-radius:999px;
	  font-weight:700;
	  font-size:12px;
	  background:#fff;
	  color:var(--muted);
	  box-shadow:var(--shadow);
	  border:1px solid rgba(0,0,0,.06);
	  cursor:pointer;
	}

	/* BF Theme (dark-ish, clean) */
	body.theme-bf{
	  background: linear-gradient(135deg,#0b1220,#111827);
	  color:#e5e7eb;
	  --bg1:#0b1220;
	  --bg2:#111827;
	  --text:#e5e7eb;
	}

	body.theme-bf .chip{ background:#0f172a; color:#cbd5e1; }
	body.theme-bf .card{ background: rgba(15,23,42,.72); }
	body.theme-bf .val{ background:#0b1220; color:#e5e7eb; }
	body.theme-bf .slider{ background:#1f2937; }
	body.theme-bf .pill{ background:#0f172a; }
	body.theme-bf .bf{ background: rgba(249,168,212,.12); color:#e5e7eb; }
	body.theme-bf .morph-pill { background:rgba(249,168,212,.12);color:#e5e7eb; }
	body.theme-bf .morph-pill .mini-btn{ background:rgba(249,168,212,.12);color:#e5e7eb; }

	body.theme-bf .aff-square{ background:#0f172a; }
	body.theme-bf .aff-square .txt{ color:#cbd5e1; }

	body.theme-bf .sendbar{
	  background: linear-gradient(to top,#0b1220,transparent);
	}
	body,
	.card,
	.chip,
	.pill,
	.val,
	.bf,
	.aff-square,
	.sendbar {
	  transition:
		background-color 260ms ease,
		color 260ms ease,
		box-shadow 260ms ease,
		border-color 260ms ease;
	}
    .status{font-size:12px;color:var(--muted);min-width:100px;text-align:right}
	.aff-grid{
	  display:grid;
	  grid-template-columns: 1fr 1fr;
	  gap:14px;
	  margin-top:14px;
	}

	.aff-square{
	  aspect-ratio: 1 / 1;
	  border-radius:18px;
	  border:2px solid transparent;
	  background:#fce7f3;
	  display:flex;
	  flex-direction:column;
	  align-items:center;
	  justify-content:center;
	  gap:8px;
	  cursor:pointer;
	  transition: all .2s ease;
	  box-shadow: 0 8px 18px rgba(0,0,0,.06);
	}

	.aff-square:hover{
	  transform: translateY(-3px);
	}

	.aff-square .emoji{
	  font-size:48px;
	  line-height:1;
	}

	.aff-square .txt{
	  font-size:13px;
	  font-weight:600;
	  color:#9d174d;
	}

	.aff-square.active{
	  background: linear-gradient(135deg,#f9a8d4,#a5b4fc);
	  border-color:white;
	}

	.aff-square.active .txt{
	  color:white;
	}

	.aff-status{
	  margin-top:12px;
	  font-size:13px;
	  color:#6b7280;
		}
	.aff-scroll{
	  display:flex;
	  gap:14px;
	  margin-top:14px;
	  padding: 2px 2px 10px;
	  overflow-x:auto;
	  -webkit-overflow-scrolling: touch;
	  scroll-snap-type: x mandatory;
	}

	.aff-scroll::-webkit-scrollbar{
	  height:8px;
	}
	.aff-scroll::-webkit-scrollbar-thumb{
	  background: rgba(0,0,0,.12);
	  border-radius: 999px;
	}

	.aff-square{
	  flex: 0 0 auto;
	  width: 120px;
	  aspect-ratio: 1 / 1;
	  border-radius:18px;
	  border:2px solid transparent;
	  background:#fce7f3;
	  display:flex;
	  flex-direction:column;
	  align-items:center;
	  justify-content:center;
	  gap:8px;
	  cursor:pointer;
	  transition: all .2s ease;
	  box-shadow: 0 8px 18px rgba(0,0,0,.06);
	  scroll-snap-align: start;
	}

	.aff-square:hover{
	  transform: translateY(-3px);
	}

	.aff-square .emoji{
	  font-size:48px;
	  line-height:1;
	}

	.aff-square .txt{
	  font-size:13px;
	  font-weight:600;
	  color:#9d174d;
	  text-align:center;
	  padding: 0 6px;
	}

	.aff-square.active{
	  background: linear-gradient(135deg,#f9a8d4,#a5b4fc);
	  border-color:white;
	}

	.aff-square.active .txt{
	  color:white;
	}

    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; min-height: 100vh; background: #f4f6f8; }

    /* top-right container */
    .top-right {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 9999;
    }

    /* the morphing pill */
    .morph-pill {
      height: var(--pill-size);
      width:  var(--pill-size);                 /* collapsed circle */
      border-radius: 999px;
      background: #fff;
	  

      display: inline-flex;
      align-items: center;

      /* IMPORTANT: anchor on the right so it expands left */
      justify-content: flex-end;

      overflow: hidden;
      white-space: nowrap;

      padding: 0;                   /* becomes padding when open */
      cursor: pointer;
      user-select: none;

      transition:
        width 420ms cubic-bezier(.2,.9,.2,1),
        padding 420ms cubic-bezier(.2,.9,.2,1),
        box-shadow 220ms ease,
        transform 120ms ease;
    }

    .morph-pill:active { transform: scale(0.98); }

    /* inner row that measures content */
    .morph-row {
      display: inline-flex;
      align-items: center;
      gap: var(--gap);
      padding-right: 4px;           /* keeps the right edge comfy */
    }

    /* the 3 circle buttons */
    .mini-btn {
      width: var(--mini-size);
      height: var(--mini-size);
      border-radius: 999px;
      background: #fff;
	  padding: 0px;

      display: inline-grid;
      place-items: center;

      font-size: var(--emoji-size);
      cursor: pointer;

      transition: transform 120ms ease, box-shadow 180ms ease;
    }

    .mini-btn:hover { box-shadow: 0 6px 16px rgba(0,0,0,.12); transform: translateY(-1px); }
    .mini-btn:active { transform: translateY(0) scale(0.98); }

    /* collapsed state: only show the right-most button */
    .morph-pill:not(.open) .mini-btn:not(:last-child) {
      opacity: 0;
      transform: translateX(10px);
      pointer-events: none;
    }

    .morph-pill .mini-btn {
      transition: opacity 220ms ease, transform 420ms cubic-bezier(.2,.9,.2,1), box-shadow 180ms ease;
    }

    /* open visuals */
    .morph-pill.open {
      box-shadow: 0 8px 22px rgba(0,0,0,.12);
      padding: var(--pill-padding);                 /* creates pill breathing room */
    }

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Freundin Status Panel</h1>
        <div class="subhead">Schieben. Senden. Freund wird informiert</div>
      </div>
      <!-- <div style="display:flex; gap:10px; align-items:center;"> -->
		  <!-- <button class="themeBtn" type="button" id="themeToggle">‚òÄÔ∏è</button> -->
	  <!-- </div> -->
	  
		<div class="morph-pill" id="pill" role="group" aria-label="Quick actions">
		  <div class="morph-row" id="row">
			<button class="mini-btn" type="button" aria-label="Logout" id="logoutBtn">üîí</a>
			<button class="mini-btn" type="button" aria-label="Theme" id="themeToggle">‚òÄÔ∏è</button>
			<button class="mini-btn" type="button" aria-label="Settings">‚öôÔ∏è</button>
		  </div>
		</div>
    </header>

    <!-- SLIDERS -->
    <div class="card">
      <div class="row">
        <div>
          <div class="label">Stimmung üòÑüòà</div>
          <div class="sub">0 = Drama, 100 = Engel</div>
        </div>
        <div class="val" id="moodVal">50</div>
      </div>
      <input class="slider" id="mood" type="range" min="0" max="100" value="50"/>
      <div class="hint"><span>üòà</span><span>üòá</span></div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div class="label">Hunger üçï</div>
          <div class="sub">0 = satt, 100 = sofort Essen</div>
        </div>
        <div class="val" id="hungerVal">40</div>
      </div>
      <input class="slider" id="hunger" type="range" min="0" max="100" value="40"/>
      <div class="hint"><span>ü•ó</span><span>üçî</span></div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div class="label">Energie üîã</div>
          <div class="sub">0 = m√ºde, 100 = Power</div>
        </div>
        <div class="val" id="energyVal">55</div>
      </div>
      <input class="slider" id="energy" type="range" min="0" max="100" value="55"/>
      <div class="hint"><span>üò¥</span><span>‚ö°</span></div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div class="label">Stress üòµ‚Äçüí´</div>
          <div class="sub">0 = entspannt, 100 = Ausnahmezustand</div>
        </div>
        <div class="val" id="stressVal">25</div>
      </div>
      <input class="slider" id="stress" type="range" min="0" max="100" value="25"/>
      <div class="hint"><span>üßò</span><span>üî•</span></div>
    </div>

	<div class="aff-scroll" id="needBar">
	  <button type="button" class="aff-square" data-need="cuddle">
		<div class="emoji">üß∏</div>
		<div class="txt">Kuscheln</div>
	  </button>

	  <button type="button" class="aff-square" data-need="kiss">
		<div class="emoji">üíã</div>
		<div class="txt">Kuss</div>
	  </button>

	  <button type="button" class="aff-square" data-need="message">
		<div class="emoji">üí¨</div>
		<div class="txt">Schreib mir</div>
	  </button>

	  <button type="button" class="aff-square" data-need="call">
		<div class="emoji">üìû</div>
		<div class="txt">Anrufen</div>
	  </button>

	  <button type="button" class="aff-square" data-need="food">
		<div class="emoji">üçî</div>
		<div class="txt">Essen</div>
	  </button>
	</div>

	<div id="affectionStatus" class="aff-status">
	  Keine akuten Anforderungen gemeldet.
	</div>




    <!-- SUMMARY -->
    <div class="card">
      <div class="summary">
        <div class="pill"><div class="k">Stimmung</div><div class="v" id="sumMood"></div></div>
        <div class="pill"><div class="k">Hunger</div><div class="v" id="sumHunger"></div></div>
        <div class="pill"><div class="k">Energie</div><div class="v" id="sumEnergy"></div></div>
        <div class="pill"><div class="k">Stress</div><div class="v" id="sumStress"></div></div>
        <div class="pill"><div class="k">Needs</div><div class="v" id="sumNeeds">keine</div></div>
        <div class="pill"><div class="k">Freund Aktion</div><div class="v" id="sumAction"></div></div>
      </div>
      <div class="bf" id="bfLine">Freund System wird vorbereitet‚Ä¶</div>
    </div>
  </div>

  <div class="sendbar">
    <div class="sendwrap">
      <button id="sendBtn">Status senden üíå</button>
      <div class="status" id="sendStatus">Bereit</div>
    </div>
  </div>

  <script>
	function getSessionToken(){
	  return localStorage.getItem("gf_session") || "";
	}

	function logout(){
	  localStorage.removeItem("gf_session");
	  window.location.href = "login.html";
	}

	function requireAuth(){
	  const token = getSessionToken();
	  if(!token){
		window.location.href = "login.html";
		return false;
	  }
	  return true;
	}

	// guard page access immediately
	if(!requireAuth()){
	  // stop running the rest if you want
	  // throw new Error("Not authenticated");
	}

	document.getElementById("logoutBtn").addEventListener("click", () => {
	  logout();
	});

	const themeToggle = document.getElementById("themeToggle");

	function applyTheme(theme){
	  document.body.classList.add("theme-switching");
	  document.body.classList.toggle("theme-bf", theme === "bf");
	  themeToggle.textContent = theme === "bf" ? "‚òÄÔ∏è" : "üåô";
	  localStorage.setItem("girlfriendos_theme", theme);
	  setTimeout(() => {
      document.body.classList.remove("theme-switching");
	  }, 300);
	}

	themeToggle.addEventListener("click", () => {
	  const current = localStorage.getItem("girlfriendos_theme") || "gf";
	  applyTheme(current === "gf" ? "bf" : "gf");
	});

	// init theme
	applyTheme(localStorage.getItem("girlfriendos_theme") || "gf");

	const needs = new Set();

	const needButtons = document.querySelectorAll("#needBar .aff-square");
	const affectionStatus = document.getElementById("affectionStatus");

	function labelForNeed(key){
	  const map = {
		cuddle: "üß∏ Kuscheln",
		kiss: "üíã Kuss",
		message: "üí¨ Nachricht",
		call: "üìû Anruf",
		food: "üçî Essen"
	  };
	  return map[key] || key;
	}

	function updateNeedsText(){
	  if(needs.size === 0){
		affectionStatus.textContent = "Keine akuten Anforderungen gemeldet.";
		return;
	  }
	  const items = [...needs].map(labelForNeed).join(" + ");
	  affectionStatus.textContent = "Angefordert: " + items;
	}

	function needsSummaryText(){
	  if (needs.size === 0) return "keine";
	  return [...needs].map(labelForNeed).join(" + ");
	}

	needButtons.forEach(btn => {
	  btn.addEventListener("click", () => {
		const key = btn.dataset.need;
		if(needs.has(key)){
		  needs.delete(key);
		  btn.classList.remove("active");
		}else{
		  needs.add(key);
		  btn.classList.add("active");
		}
		updateNeedsText();

		// Optional: keep your summary/action in sync
		render();
	  });
	});

	updateNeedsText();


    const el=id=>document.getElementById(id);
    const sliders=["mood","hunger","energy","stress"];

    function txt(v,a,b,c,d){if(v<25)return a;if(v<50)return b;if(v<75)return c;return d}

    function render(){
      const mood=+el("mood").value;
      const hunger=+el("hunger").value;
      const energy=+el("energy").value;
      const stress=+el("stress").value;

      el("moodVal").textContent=mood;
      el("hungerVal").textContent=hunger;
      el("energyVal").textContent=energy;
      el("stressVal").textContent=stress;

      el("sumMood").textContent=txt(mood,"Drama","Meh","Gut drauf","Engel");
      el("sumHunger").textContent=txt(hunger,"Satt","Snack bald","Hungrig","SOFORT ESSEN");
      el("sumEnergy").textContent=txt(energy,"Schlafmodus","M√ºde","Okay","Power");
      el("sumStress").textContent=txt(stress,"Zen","Leicht gestresst","Gestresst","ALARM");
	  el("sumNeeds").textContent = needsSummaryText();

      let action="Bereitschaft halten";
      if(hunger>80)action="Essen organisieren";
      else if(stress>80)action="Beruhigen + Umarmen";
      else if(mood<20)action="Sehr lieb sein";

      el("sumAction").textContent=action;
      el("bfLine").textContent="Freund Protokoll: "+action;
    }

    sliders.forEach(s=>el(s).addEventListener("input",render));
    render();
	const sendBtn = document.getElementById("sendBtn");
	const sendStatusEl = document.getElementById("sendStatus");

	async function sendStatus(){
	  sendBtn.disabled = true;
	  sendStatusEl.textContent = "Senden‚Ä¶";

	  const payload = {
		mood: +el("mood").value,
		hunger: +el("hunger").value,
		energy: +el("energy").value,
		stress: +el("stress").value,
		needs: [...needs].map(x => x), // array
		note: null
	  };
		const token = getSessionToken();
	  try{
		  const res = await fetch("/api/status", {
		  method: "POST",
		  headers: { 
			"Content-Type": "application/json",
			"X-GF-Session": token
		  },
		  body: JSON.stringify(payload)
		});
		
		if(res.status === 401){
			alert("Session abgelaufen ü•≤ Bitte neu einloggen.");
			logout();
			return;
		}
		if(!res.ok){
		  const t = await res.text().catch(() => "");
		  throw new Error(`HTTP ${res.status} ${t}`.trim());
		}

		sendStatusEl.textContent = "Gesendet ‚úÖ";
		setTimeout(() => sendStatusEl.textContent = "Bereit", 1500);
	  }catch(err){
		console.error(err);
		sendStatusEl.textContent = "Fehler ‚ùå";
		alert("Senden fehlgeschlagen. Ist /api/status erreichbar?");
		setTimeout(() => sendStatusEl.textContent = "Bereit", 2000);
	  }finally{
		sendBtn.disabled = false;
	  }
	}

	sendBtn.addEventListener("click", sendStatus);

    const pill = document.getElementById("pill");
    const row = document.getElementById("row");

    function setCollapsed() {
      pill.classList.remove("open");
      pill.style.width = "38px";
      pill.style.padding = "0px";
    }

    function setOpen() {
      pill.classList.add("open");
      // Measure content width and set pill width so it expands LEFT and fits contents.
      // The right edge stays fixed because the container is fixed to top-right.
		const targetWidth = 110;
      pill.style.width = targetWidth + "px";
    }

    // Start collapsed
    setCollapsed();

    // Toggle on click (clicking anywhere on the pill)
    pill.addEventListener("click", (e) => {
      // If you only want the right-most button to toggle, remove this and attach to that button.
      const isOpen = pill.classList.contains("open");
      if (isOpen) setCollapsed();
      else setOpen();
    });

    // Close when clicking outside
    document.addEventListener("click", (e) => {
      if (!pill.contains(e.target)) setCollapsed();
    });

    // Recalculate when window resizes (fonts, zoom, etc.)
    window.addEventListener("resize", () => {
      if (pill.classList.contains("open")) setOpen();
    });
  </script>
  </body>
</html>
